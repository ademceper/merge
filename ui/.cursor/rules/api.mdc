---
description: API integration and data fetching rules
globs: ["packages/api/**", "packages/store/**", "**/actions/**", "**/server/**"]
---

# API & State Management Rules

## Architecture
```
packages/api/        → Shared API client + fetch functions
packages/store/      → Zustand stores (cart, wishlist, auth)
packages/validators/ → Zod schemas
apps/web/actions/    → Next.js Server Actions (BFF)
apps/mobile/server/  → Expo Server Functions (BFF)
```

## API Client (packages/api/client.ts)
```tsx
const API_URL = process.env.API_URL

export async function apiClient<T>(
  endpoint: string,
  options?: RequestInit
): Promise<T> {
  const res = await fetch(`${API_URL}${endpoint}`, {
    ...options,
    headers: {
      'Content-Type': 'application/json',
      ...options?.headers,
    },
  })

  if (!res.ok) {
    throw new Error(`API Error: ${res.status}`)
  }

  return res.json()
}
```

## Zod Schemas (packages/validators/)
```tsx
import { z } from 'zod'

export const productSchema = z.object({
  id: z.string(),
  name: z.string().min(1),
  price: z.number().positive(),
  image: z.string().url(),
})

export type Product = z.infer<typeof productSchema>
export const productsSchema = z.array(productSchema)
```

## TanStack Query Hooks
```tsx
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'

// Query hook
export function useProducts() {
  return useQuery({
    queryKey: ['products'],
    queryFn: () => apiClient<Product[]>('/products'),
    staleTime: 2 * 60 * 1000, // 2 minutes
  })
}

// Mutation hook
export function useAddToCart() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: (productId: string) =>
      apiClient('/cart', { method: 'POST', body: JSON.stringify({ productId }) }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['cart'] })
    },
  })
}
```

## Cache Strategy
```tsx
const cacheConfig = {
  cart: { staleTime: 0 },                    // Always fresh
  products: { staleTime: 2 * 60 * 1000 },    // 2 min
  categories: { staleTime: 10 * 60 * 1000 }, // 10 min
  user: { staleTime: 5 * 60 * 1000 },        // 5 min
  orders: { staleTime: 30 * 1000 },          // 30 sec
  settings: { staleTime: 60 * 60 * 1000 },   // 1 hour
}
```

## Zustand Stores (packages/store/)
```tsx
import { create } from 'zustand'
import { persist, createJSONStorage } from 'zustand/middleware'

interface CartStore {
  items: CartItem[]
  addItem: (item: CartItem) => void
  removeItem: (id: string) => void
  clearCart: () => void
}

export const useCartStore = create<CartStore>()(
  persist(
    (set) => ({
      items: [],
      addItem: (item) => set((state) => ({
        items: [...state.items, item]
      })),
      removeItem: (id) => set((state) => ({
        items: state.items.filter((i) => i.id !== id)
      })),
      clearCart: () => set({ items: [] }),
    }),
    {
      name: 'cart-storage',
      storage: createJSONStorage(() => localStorage), // or MMKV for mobile
    }
  )
)
```

## Server Actions (BFF Pattern)
```tsx
'use server'
import { apiClient } from '@merge/api'
import { productsSchema } from '@merge/validators'

export async function getProducts() {
  const data = await apiClient('/products')
  return productsSchema.parse(data) // Validate response
}
```
