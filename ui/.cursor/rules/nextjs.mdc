---
description: Next.js 16 specific rules
globs: ["apps/web/**/*.tsx", "apps/web/**/*.ts"]
---

# Next.js 16 Rules

## App Router Structure
```
apps/web/app/
├── (auth)/           # Auth routes (login, register)
├── (shop)/           # E-commerce (products, cart, checkout)
├── (account)/        # User dashboard (orders, profile)
├── layout.tsx        # Root layout
├── page.tsx          # Home page
├── error.tsx         # Error boundary (must be 'use client')
├── loading.tsx       # Loading UI
└── not-found.tsx     # 404 page
```

## Server Components (Default)
- Fetch data directly in components
- No useState/useEffect for data
- Use async/await

## Client Components
Add `'use client'` only when needed:
- useState, useEffect, useContext
- Event handlers (onClick, onChange)
- Browser APIs
- Third-party client libraries

## Server Actions
```tsx
'use server'
import { getProducts } from '@merge/api'

export async function fetchProducts() {
  return getProducts() // BFF pattern - proxy to backend
}
```

## Images
ALWAYS use next/image:
```tsx
import Image from 'next/image'

<Image
  src="/product.jpg"
  alt="Product"
  width={400}
  height={300}
  priority // for LCP images
/>
```

## Error Boundaries
Every route group should have `error.tsx`:
```tsx
'use client'

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  return (
    <div>
      <h2>Something went wrong!</h2>
      <button onClick={() => reset()}>Try again</button>
    </div>
  )
}
```

## Metadata
```tsx
export const metadata = {
  title: 'Page Title',
  description: 'Page description',
}
```

## Security Headers
Configure in next.config.mjs:
- Content-Security-Policy
- X-Frame-Options: SAMEORIGIN
- X-Content-Type-Options: nosniff

## Performance
- Use dynamic imports for heavy components
- Implement loading.tsx for Suspense
- Use React.memo for expensive renders

## UI Package Component Usage (CRITICAL)

### MANDATORY Component Usage
**ALWAYS use @merge/ui components instead of native HTML:**

1. **Buttons**: NEVER use `<button>` - ALWAYS use `Button` from `@merge/ui/components/button`
   ```tsx
   // ❌ FORBIDDEN
   <button onClick={handleClick}>Click</button>
   
   // ✅ REQUIRED
   import { Button } from "@merge/ui/components/button"
   <Button onClick={handleClick}>Click</Button>
   ```

2. **Form Fields**: ALWAYS wrap inputs with Field components
   ```tsx
   // ❌ FORBIDDEN
   <input type="email" placeholder="Email" />
   
   // ✅ REQUIRED
   import { Field, FieldContent, FieldLabel, FieldError } from "@merge/ui/components/field"
   import { Input } from "@merge/ui/components/input"
   
   <Field>
     <FieldContent>
       <Input type="email" placeholder="Email" />
     </FieldContent>
   </Field>
   ```

3. **Links**: Use Button with variant="link" or variant="ghost"
   ```tsx
   // ❌ FORBIDDEN
   <button type="button" onClick={handleClick} className="hover:underline">Link</button>
   
   // ✅ REQUIRED
   <Button variant="link" onClick={handleClick}>Link</Button>
   ```

### Available Components
Check `packages/ui/src/components/` for available components:
- Button, Input, Field, FieldContent, FieldLabel, FieldError
- Card, CardHeader, CardContent, CardFooter
- Label, Separator, Badge, etc.

### Pre-commit Checklist
Before creating/editing web pages:
- [ ] All buttons use `Button` component
- [ ] All inputs wrapped in `Field` + `FieldContent`
- [ ] All links use `Button` with variant="link" or "ghost"
- [ ] Error messages use `FieldError` component
- [ ] No native HTML form elements without UI package wrappers
