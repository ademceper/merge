---
description: Expo and React Native specific rules
globs: ["apps/mobile/**/*.tsx", "apps/mobile/**/*.ts"]
---

# Expo 54 & React Native Rules

## Expo Router Structure
```
apps/mobile/app/
├── (auth)/           # Auth screens
│   ├── _layout.tsx
│   ├── login.tsx
│   └── register.tsx
├── (tabs)/           # Tab navigation
│   ├── _layout.tsx   # Tab bar config
│   ├── home.tsx
│   ├── search.tsx
│   ├── cart.tsx
│   └── profile.tsx
├── (stack)/          # Stack screens
│   ├── product/[id].tsx
│   ├── checkout.tsx
│   └── orders/[id].tsx
├── _layout.tsx       # Root layout
├── index.tsx         # Entry/splash
└── +not-found.tsx    # 404
```

## Screen Template
```tsx
import { View } from 'react-native'
import { useSafeAreaInsets } from 'react-native-safe-area-context'
import { Text } from '@merge/uim/components/text'

export default function Screen() {
  const insets = useSafeAreaInsets()

  return (
    <View className="flex-1 bg-background" style={{ paddingTop: insets.top }}>
      <Text>Content</Text>
    </View>
  )
}
```

## Server Functions (BFF)
```tsx
'use server'
import { getProducts } from '@merge/api'

export async function fetchProducts() {
  return getProducts()
}
```

## Lists - Use FlatList
NEVER use ScrollView for lists >10 items:
```tsx
import { FlatList } from 'react-native'

<FlatList
  data={items}
  renderItem={({ item }) => <Item {...item} />}
  keyExtractor={(item) => item.id}
  removeClippedSubviews={true}
  maxToRenderPerBatch={10}
/>
```

## Animations
Use react-native-reanimated (runs on UI thread):
```tsx
import Animated, { useAnimatedStyle, withSpring } from 'react-native-reanimated'

const animatedStyle = useAnimatedStyle(() => ({
  transform: [{ translateX: withSpring(position.value) }],
}))
```

## Secure Storage
```tsx
import * as SecureStore from 'expo-secure-store'

await SecureStore.setItemAsync('token', value)
const token = await SecureStore.getItemAsync('token')
```

## Deep Linking
Universal Links configuration in app.json:
```json
{
  "expo": {
    "scheme": "merge",
    "android": { "intentFilters": [...] },
    "ios": { "associatedDomains": ["applinks:merge.com"] }
  }
}
```

## Timer Cleanup
ALWAYS cleanup timers:
```tsx
useEffect(() => {
  const timer = setTimeout(() => {}, 1000)
  return () => clearTimeout(timer)
}, [])
```

## UI Package Component Usage (CRITICAL - MANDATORY)

### ⚠️ CRITICAL RULE: NEVER use native React Native elements when @merge/uim alternatives exist

**This is a MANDATORY requirement. Violations will be caught and must be fixed.**

### MANDATORY Component Usage

1. **Buttons**: NEVER use `Pressable` for buttons - ALWAYS use `Button` from `@merge/uim/components/button`
   ```tsx
   // ❌ FORBIDDEN - This will be flagged
   import { Pressable } from "react-native"
   <Pressable onPress={handlePress}>
     <Text>Click</Text>
   </Pressable>
   
   // ✅ REQUIRED - Always use Button component
   import { Button } from "@merge/uim/components/button"
   <Button onPress={handlePress}>Click</Button>
   
   // For link-style buttons, use variant="ghost"
   <Button variant="ghost" onPress={handlePress} className="h-auto p-0">
     <Text>Link text</Text>
   </Button>
   ```

2. **Text**: ALWAYS use `Text` from `@merge/uim/components/text`
   ```tsx
   // ❌ FORBIDDEN
   import { Text } from "react-native"
   <Text>Hello</Text>
   
   // ✅ REQUIRED
   import { Text } from "@merge/uim/components/text"
   <Text>Hello</Text>
   ```

3. **Inputs**: ALWAYS use `Input` from `@merge/uim/components/input`
   ```tsx
   // ❌ FORBIDDEN
   import { TextInput } from "react-native"
   <TextInput placeholder="Email" />
   
   // ✅ REQUIRED
   import { Input } from "@merge/uim/components/input"
   <Input placeholder="Email" />
   ```

4. **Cards**: Use Card components from `@merge/uim/components/card`
   ```tsx
   import { Card, CardHeader, CardContent } from "@merge/uim/components/card"
   <Card>
     <CardHeader>Title</CardHeader>
     <CardContent>Content</CardContent>
   </Card>
   ```

### Available Components
Check `packages/uim/src/components/` for available components:
- Button, Input, Text, Card, Badge, Checkbox, Switch, etc.

### Pre-commit Checklist (MANDATORY)
**Before creating/editing ANY mobile screen, verify:**
- [ ] ❌ NO `Pressable` imports from "react-native" - use `Button` instead
- [ ] ❌ NO `TextInput` imports from "react-native" - use `Input` instead
- [ ] ❌ NO `Text` imports from "react-native" - use `Text` from `@merge/uim` instead
- [ ] ✅ ALL buttons use `Button` from `@merge/uim/components/button`
- [ ] ✅ ALL text uses `Text` from `@merge/uim/components/text`
- [ ] ✅ ALL inputs use `Input` from `@merge/uim/components/input`
- [ ] ✅ Link-style buttons use `Button variant="ghost"` with `className="h-auto p-0"`

### Common Mistakes to Avoid
```tsx
// ❌ WRONG - Using Pressable
import { Pressable } from "react-native"
<Pressable onPress={handleClick}>Click</Pressable>

// ✅ CORRECT - Using Button
import { Button } from "@merge/uim/components/button"
<Button onPress={handleClick}>Click</Button>

// ❌ WRONG - Native Text
import { Text } from "react-native"

// ✅ CORRECT - UI Package Text
import { Text } from "@merge/uim/components/text"

// ❌ WRONG - Native TextInput
import { TextInput } from "react-native"
<TextInput placeholder="Email" />

// ✅ CORRECT - UI Package Input
import { Input } from "@merge/uim/components/input"
<Input placeholder="Email" />
```

## NativeWind Usage (CRITICAL - MANDATORY)

### ⚠️ CRITICAL RULE: ALWAYS use NativeWind className instead of inline styles or hardcoded colors

**This is a MANDATORY requirement. NEVER hardcode colors or use inline styles when NativeWind alternatives exist.**

### MANDATORY NativeWind Usage

1. **ALWAYS use NativeWind className for styling**
   ```tsx
   // ❌ FORBIDDEN - Hardcoded colors
   <View style={{ backgroundColor: isDark ? "#101022" : "#ffffff" }} />
   <View className={isDark ? "bg-[#101022]" : "bg-white"} />
   
   // ✅ REQUIRED - Use Tailwind config colors
   <View className="bg-background dark:bg-[#101022]" />
   ```

2. **ALWAYS use Tailwind config colors, NEVER hardcode hex values**
   ```tsx
   // ❌ FORBIDDEN - Hardcoded colors
   className="bg-[#101022] text-[#111118] border-[#111118]/10"
   
   // ✅ REQUIRED - Use Tailwind config colors
   className="bg-background text-foreground border-border"
   className="bg-background dark:bg-[#101022] text-foreground dark:text-white"
   ```

3. **Use NativeWind for all layout and styling**
   ```tsx
   // ❌ FORBIDDEN - Inline styles
   <View style={{ flex: 1, padding: 16, backgroundColor: "#fff" }} />
   
   // ✅ REQUIRED - NativeWind className
   <View className="flex-1 p-4 bg-background" />
   ```

4. **Dynamic values (insets, calculations) can use style prop, but prefer NativeWind**
   ```tsx
   // ✅ ACCEPTABLE - Dynamic values need style
   <View className="flex-1 bg-background" style={{ paddingTop: insets.top }} />
   
   // ❌ FORBIDDEN - Static values in style
   <View style={{ padding: 16, backgroundColor: "#fff" }} />
   
   // ✅ REQUIRED - Use NativeWind for static values
   <View className="p-4 bg-background" />
   ```

5. **React Navigation props that require style objects are exceptions**
   ```tsx
   // ✅ ACCEPTABLE - React Navigation requires style objects
   tabBarStyle: {
     height: 64 + insets.bottom, // Dynamic calculation
     paddingBottom: insets.bottom + 4,
   }
   
   // But use NativeWind for colors in custom components
   tabBarBackground: () => (
     <View className="flex-1 border-t bg-background dark:bg-[#101022] border-border" />
   )
   ```

### Available Tailwind Colors (from config)
- `bg-background` / `text-foreground` - Main background/text
- `bg-card` / `text-card-foreground` - Card background/text
- `bg-primary` / `text-primary-foreground` - Primary colors
- `bg-secondary` / `text-secondary-foreground` - Secondary colors
- `bg-muted` / `text-muted-foreground` - Muted colors
- `bg-accent` / `text-accent-foreground` - Accent colors
- `border-border` - Border color
- `border-input` - Input border color

### Dark Mode Pattern
```tsx
// ✅ CORRECT - Use dark: prefix for dark mode
<View className="bg-background dark:bg-[#101022] text-foreground dark:text-white" />
<View className="border-border dark:border-white/10" />

// ❌ FORBIDDEN - Conditional className with ternary
<View className={isDark ? "bg-[#101022]" : "bg-white"} />
```

### Pre-commit Checklist (MANDATORY)
**Before creating/editing ANY mobile screen, verify:**
- [ ] ❌ NO hardcoded hex colors (`#101022`, `#111118`, etc.) - use Tailwind config colors
- [ ] ❌ NO inline styles for static values - use NativeWind className
- [ ] ❌ NO conditional className with ternary for colors - use `dark:` prefix
- [ ] ✅ ALL colors use Tailwind config colors (`bg-background`, `text-foreground`, etc.)
- [ ] ✅ ALL layout/spacing use NativeWind (`flex-1`, `p-4`, `gap-4`, etc.)
- [ ] ✅ Dark mode uses `dark:` prefix, not conditional logic

### Common Mistakes to Avoid
```tsx
// ❌ WRONG - Hardcoded colors
<View style={{ backgroundColor: "#101022" }} />
<View className="bg-[#101022]" />

// ✅ CORRECT - Tailwind config colors
<View className="bg-background dark:bg-[#101022]" />

// ❌ WRONG - Conditional className
<View className={isDark ? "bg-[#101022]" : "bg-white"} />

// ✅ CORRECT - Dark mode prefix
<View className="bg-background dark:bg-[#101022]" />

// ❌ WRONG - Inline styles for static values
<View style={{ padding: 16, gap: 8 }} />

// ✅ CORRECT - NativeWind className
<View className="p-4 gap-2" />
```

## UIM Package Maximum Usage (CRITICAL - MANDATORY)

### ⚠️ CRITICAL RULE: ALWAYS use @merge/uim components and UIM color tokens to the maximum extent possible

**This is the HIGHEST PRIORITY requirement. Use @merge/uim for EVERYTHING that has an equivalent.**

### MANDATORY: Maximum UIM Component Usage

1. **ALWAYS check packages/uim/src/components/ FIRST before using any React Native element**
   ```tsx
   // Before writing any UI code, check if UIM has a component for it:
   // - Button, Text, Input, Card, Badge, Checkbox, Switch
   // - Icon, Avatar, Separator, Progress, Skeleton
   // - Dialog, Sheet, Popover, Tooltip, Alert
   // - ScrollView, FlatList wrappers if available
   ```

2. **ALWAYS use UIM color tokens via NativeWind className**
   ```tsx
   // ❌ FORBIDDEN - Using useColorScheme for colors
   const colorScheme = useColorScheme()
   const isDark = colorScheme === "dark"
   <View style={{ backgroundColor: isDark ? "#fff" : "#000" }} />

   // ✅ REQUIRED - Use UIM color tokens
   <View className="bg-primary" />
   <View className="bg-background" />
   <View className="bg-secondary" />
   <View className="text-foreground" />
   <View className="text-muted-foreground" />
   <View className="border-border" />
   ```

3. **Available UIM Color Tokens (USE THESE ALWAYS)**
   ```tsx
   // Backgrounds
   className="bg-background"       // Main background
   className="bg-primary"          // Primary/inverted background
   className="bg-secondary"        // Secondary background
   className="bg-muted"            // Muted background
   className="bg-card"             // Card background
   className="bg-destructive"      // Error/danger background

   // Text Colors
   className="text-foreground"         // Primary text
   className="text-primary-foreground" // Text on primary bg
   className="text-muted-foreground"   // Muted/secondary text
   className="text-destructive"        // Error text

   // Borders
   className="border-border"           // Standard border
   className="border-input"            // Input border
   className="border-primary"          // Primary border

   // With opacity
   className="bg-primary/10"           // 10% opacity
   className="text-foreground/80"      // 80% opacity
   className="border-border/50"        // 50% opacity
   ```

4. **When SVG or native components REQUIRE hex values**
   ```tsx
   // Only exception: SVG components that require hex values
   // In this case, define colors based on design system:
   const colors = {
     destructive: "#ef4444",
     primary: isDark ? "#ffffff" : "#111118",
     border: isDark ? "rgba(255, 255, 255, 0.2)" : "#e5e5e5",
   };

   // But ALWAYS prefer UIM when possible:
   <View className="bg-destructive" />  // ✅ Preferred
   <Circle stroke={colors.destructive} /> // Only when SVG requires it
   ```

### Pre-commit Checklist for UIM Usage (MANDATORY)
**EVERY code review MUST verify:**
- [ ] ✅ ALL Text uses `Text` from `@merge/uim/components/text`
- [ ] ✅ ALL Buttons use `Button` from `@merge/uim/components/button`
- [ ] ✅ ALL Inputs use `Input` from `@merge/uim/components/input`
- [ ] ✅ ALL Cards use `Card` from `@merge/uim/components/card`
- [ ] ✅ ALL Badges use `Badge` from `@merge/uim/components/badge`
- [ ] ✅ ALL Icons use `Icon` from `@merge/uim/components/icon`
- [ ] ✅ ALL colors use UIM tokens (`bg-primary`, `text-foreground`, etc.)
- [ ] ❌ NO hardcoded hex colors (`#111118`, `#ffffff`, etc.)
- [ ] ❌ NO useColorScheme for manual color switching when NativeWind handles it
- [ ] ❌ NO inline style colors when className can be used

### UIM Component Priority List
**Check these components FIRST before using native equivalents:**
1. `@merge/uim/components/text` → for ALL text
2. `@merge/uim/components/button` → for ALL buttons/pressables
3. `@merge/uim/components/input` → for ALL text inputs
4. `@merge/uim/components/card` → for ALL card containers
5. `@merge/uim/components/badge` → for ALL badges/tags
6. `@merge/uim/components/icon` → for ALL icons
7. `@merge/uim/components/checkbox` → for checkboxes
8. `@merge/uim/components/switch` → for switches
9. `@merge/uim/components/avatar` → for avatars
10. `@merge/uim/components/separator` → for dividers
